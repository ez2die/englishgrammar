# 拍照OCR识别句子分析功能需求说明书

## 1. 项目概述

### 1.1 项目背景
Grammar Master 是一个英语语法学习应用，帮助用户通过句子结构分析学习英语语法。现有功能支持AI自动生成句子进行分析，但用户无法直接分析自己感兴趣的句子。

### 1.2 项目目标
新增拍照上传功能，允许用户通过拍照或上传图片的方式，使用OCR技术识别图片中的英文句子，然后将识别到的句子进行分析，形成语法分析题目。

### 1.3 项目范围
- ✅ 支持图片文件上传
- ✅ 支持摄像头实时拍照
- ✅ OCR文字识别（英文）
- ✅ 识别文本自动生成语法分析题目
- ❌ 不包含图片编辑功能
- ❌ 不支持批量图片处理
- ❌ 不支持多语言OCR

---

## 2. 功能需求

### 2.1 图片上传功能

#### 2.1.1 图片选择上传
**需求编号**: FR-001  
**优先级**: 高

**功能描述**:
- 用户可以通过点击按钮选择本地图片文件
- 支持常见图片格式：JPG、PNG、GIF、WebP等
- 文件大小限制：最大10MB
- 自动验证文件类型和大小

**用户交互**:
1. 用户点击"选择图片"按钮
2. 打开系统文件选择对话框
3. 用户选择图片文件
4. 系统验证文件有效性
5. 显示图片预览

**异常处理**:
- 文件类型不支持：提示"请选择图片文件"
- 文件过大：提示"图片文件过大，请选择小于10MB的图片"
- 文件读取失败：提示"文件读取失败，请重试"

---

#### 2.1.2 摄像头拍照功能
**需求编号**: FR-002  
**优先级**: 高

**功能描述**:
- 用户可以通过点击按钮打开摄像头进行实时拍照
- 优先使用后置摄像头（移动设备）
- 提供拍照和取消按钮
- 拍照后自动捕获图像

**用户交互**:
1. 用户点击"拍照"按钮
2. 系统请求摄像头权限
3. 显示实时预览画面
4. 用户点击"拍照"按钮捕获图像
5. 系统关闭摄像头并处理图像

**异常处理**:
- 浏览器不支持摄像头：提示"您的浏览器不支持摄像头功能"
- 权限被拒绝：提示"无法访问摄像头，请检查权限设置"
- 摄像头设备不可用：提示"未检测到摄像头设备"

---

### 2.2 OCR文字识别功能

#### 2.2.1 图片文字识别
**需求编号**: FR-003  
**优先级**: 高

**功能描述**:
- 使用Tesseract.js进行浏览器端OCR识别
- 识别英文文本内容
- 自动清理识别结果（去除多余空格、换行等）
- 显示识别进度提示

**技术规格**:
- OCR引擎：Tesseract.js v5.1.0+
- 识别语言：英文（eng）
- 字符白名单：英文字母、数字、常用标点符号

**处理流程**:
1. 接收图片文件
2. 初始化OCR Worker
3. 执行OCR识别
4. 清理识别文本
5. 返回识别结果

**异常处理**:
- OCR识别失败：提示"图片识别失败，请确保图片清晰且包含英文文本"
- 识别结果为空：提示"未能识别到文本，请确保图片清晰且包含英文文本"
- Worker初始化失败：提示"OCR引擎初始化失败，请刷新页面重试"

---

#### 2.2.2 文本清理与验证
**需求编号**: FR-004  
**优先级**: 中

**功能描述**:
- 自动清理识别结果中的多余空格和换行
- 去除首尾空白字符
- 验证识别文本的有效性（非空、包含英文字符）

**清理规则**:
- 多个连续换行符替换为单个空格
- 多个连续空格替换为单个空格
- 去除首尾空白字符

---

### 2.3 句子分析功能

#### 2.3.1 自定义句子分析
**需求编号**: FR-005  
**优先级**: 高

**功能描述**:
- 将OCR识别的文本发送到后端API进行分析
- 后端使用AI生成完整的语法分析数据
- 返回分析结果并进入游戏界面

**API规格**:
- 端点：`POST /api/analyze-sentence`
- 请求参数：
  ```json
  {
    "sentence": "识别的文本",
    "level": "Intermediate" // 可选，默认Intermediate
  }
  ```
- 响应格式：与现有 `/api/generate` 端点相同

**处理流程**:
1. OCR识别完成，获得文本
2. 调用 `/api/analyze-sentence` API
3. 等待AI分析完成
4. 解析返回的分析数据
5. 进入游戏界面展示

**异常处理**:
- API请求失败：提示相应错误信息
- 分析超时：提示"分析超时，请稍后再试"
- 返回数据格式错误：提示"分析数据格式错误，请重试"

---

### 2.4 用户界面功能

#### 2.4.1 主页集成
**需求编号**: FR-006  
**优先级**: 高

**功能描述**:
- 在主页面（级别选择界面）添加"拍照分析句子"功能卡片
- 卡片位于级别选择按钮之前
- 提供清晰的视觉引导

**UI设计要求**:
- 使用与其他卡片一致的设计风格
- 明确的功能说明文字
- 提供两个操作按钮："选择图片"和"拍照"
- 显示处理状态（加载中、错误提示等）

---

#### 2.4.2 图片预览
**需求编号**: FR-007  
**优先级**: 中

**功能描述**:
- 选择或拍摄图片后，显示图片预览
- 预览区域显示识别进度提示
- 预览图片自动适应容器大小

**UI要求**:
- 图片预览区域：圆角矩形，带边框
- 加载状态：显示"正在识别文字..."提示
- 错误状态：显示错误提示信息

---

## 3. 非功能需求

### 3.1 性能要求
**需求编号**: NFR-001

- OCR识别响应时间：单张图片识别时间 < 10秒（取决于图片大小和复杂度）
- API响应时间：句子分析API响应时间 < 30秒
- 图片上传大小限制：最大10MB
- 图片分辨率支持：建议不超过4096x4096像素

---

### 3.2 兼容性要求
**需求编号**: NFR-002

- 浏览器支持：
  - Chrome 80+
  - Firefox 75+
  - Safari 13+
  - Edge 80+
- 移动设备支持：
  - iOS Safari 13+
  - Chrome Mobile 80+
- 摄像头访问：需要HTTPS环境或localhost

---

### 3.3 安全性要求
**需求编号**: NFR-003

- 图片处理在浏览器本地完成（OCR），不上传到服务器
- OCR识别的文本通过HTTPS传输到服务器
- 用户隐私：识别的图片和文本仅在当前会话使用
- 文件大小限制防止恶意上传

---

### 3.4 可访问性要求
**需求编号**: NFR-004

- 按钮提供清晰的文字标签
- 错误提示信息明确易懂
- 支持键盘导航
- 加载状态有视觉反馈

---

## 4. 用户故事

### 用户故事 1：学生想要分析课本中的句子
**作为** 一名学习英语的学生  
**我希望** 能够拍照识别课本中的英文句子  
**以便于** 理解这些句子的语法结构

**验收标准**:
- [ ] 可以打开摄像头拍照
- [ ] 可以识别图片中的英文文字
- [ ] 识别后自动生成分析题目

---

### 用户故事 2：老师想要分析教学材料
**作为** 一名英语老师  
**我希望** 能够上传图片文件分析句子  
**以便于** 快速准备教学材料

**验收标准**:
- [ ] 可以选择本地图片文件上传
- [ ] 支持常见图片格式
- [ ] 上传后自动识别并分析

---

### 用户故事 3：用户想要分析网络上的句子
**作为** 一名用户  
**我希望** 能够截图后直接分析句子  
**以便于** 学习网页或应用中的英语句子

**验收标准**:
- [ ] 可以上传截图文件
- [ ] 识别准确率满足基本需求
- [ ] 分析结果正确完整

---

## 5. 技术规格

### 5.1 前端技术栈

#### 5.1.1 OCR库
- **库名**: Tesseract.js
- **版本**: ^5.1.0
- **用途**: 浏览器端OCR文字识别
- **特点**: 
  - 纯JavaScript实现，无需服务器端支持
  - 支持多语言识别
  - Web Worker实现，不阻塞UI

#### 5.1.2 图片处理
- **HTML5 File API**: 用于文件选择和读取
- **MediaDevices API**: 用于摄像头访问
- **Canvas API**: 用于图片预览和处理

---

### 5.2 后端技术规格

#### 5.2.1 API端点

**端点**: `POST /api/analyze-sentence`

**请求**:
```json
{
  "sentence": "The talented musician from our small town played a beautiful melody.",
  "level": "Intermediate"
}
```

**响应**:
```json
{
  "originalSentence": "The talented musician from our small town played a beautiful melody.",
  "words": ["The", "talented", "musician", ...],
  "wordRoles": {...},
  "structureType": "主谓宾 (SVO)",
  "skeletonIndices": [2, 7, 10],
  "explanation": "...",
  "options": [...],
  "level": "Intermediate"
}
```

**错误响应**:
- 400: 请求参数错误
- 429: 请求过于频繁
- 500: 服务器内部错误
- 503: AI服务不可用

---

#### 5.2.2 后端服务修改

**新增方法**:

1. **PromptBuilder.buildAnalysisPrompt(sentence, level)**
   - 构建用于分析自定义句子的Prompt
   - 参数：句子文本、难度级别
   - 返回：完整的Prompt字符串

2. **SentenceAnalysisService.analyzeCustomSentence(sentence, level, options)**
   - 分析自定义句子
   - 参数：句子文本、难度级别、选项
   - 返回：SentenceAnalysisData对象

---

### 5.3 文件结构

```
English-master_-english-analysis/
├── components/
│   └── ImageUploader.tsx          # 新增：图片上传组件
├── services/
│   ├── ocrService.ts              # 新增：OCR服务
│   └── geminiService.ts           # 修改：添加analyzeSentence方法
├── server/
│   ├── services/
│   │   ├── prompts/
│   │   │   └── PromptBuilder.js   # 修改：添加buildAnalysisPrompt方法
│   │   └── application/
│   │       └── SentenceAnalysisService.js  # 修改：添加analyzeCustomSentence方法
│   └── server.js                  # 修改：添加/api/analyze-sentence端点
├── App.tsx                        # 修改：集成OCR功能
└── package.json                   # 修改：添加tesseract.js依赖
```

---

## 6. 界面设计说明

### 6.1 主页集成位置

在主页面（级别选择界面）中，在级别选择按钮之前添加新的功能卡片：

```
┌─────────────────────────────────────┐
│      Grammar Master (标题)           │
│   Master English Sentence Structure │
└─────────────────────────────────────┐
│                                     │
│  ┌───────────────────────────────┐ │
│  │   📸 拍照分析句子               │ │
│  │                               │ │
│  │  [📁 选择图片] [📷 拍照]       │ │
│  │                               │ │
│  │  [图片预览区域]                │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  Level 1: Basic               │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │  Level 2: Intermediate        │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │  Level 3: Advanced            │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

---

### 6.2 摄像头界面

当用户点击"拍照"按钮时，显示全屏摄像头预览：

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│         [摄像头预览画面]             │
│                                     │
│                                     │
│                                     │
│         [📸 拍照]                   │
│         [✕ 取消]                    │
└─────────────────────────────────────┘
```

---

### 6.3 状态提示

**加载状态**:
- 显示旋转加载图标
- 文字提示："正在识别文字..."
- 禁用操作按钮

**成功状态**:
- 自动跳转到游戏界面
- 显示识别到的句子

**错误状态**:
- 显示错误提示信息
- 红色背景的提示框
- 允许用户重试

---

## 7. 验收标准

### 7.1 功能验收

- [ ] **FR-001**: 用户可以选择图片文件上传，支持JPG、PNG等格式，限制10MB
- [ ] **FR-002**: 用户可以打开摄像头拍照，支持后置摄像头
- [ ] **FR-003**: OCR能够识别图片中的英文文字，准确率>85%
- [ ] **FR-004**: 识别文本自动清理多余空格和换行
- [ ] **FR-005**: 识别的文本能够成功调用API进行分析
- [ ] **FR-006**: 主页正确显示"拍照分析句子"功能卡片
- [ ] **FR-007**: 选择/拍摄图片后显示预览，并显示处理状态

---

### 7.2 性能验收

- [ ] OCR识别时间 < 10秒（正常图片）
- [ ] API分析响应时间 < 30秒
- [ ] 图片预览加载流畅，无卡顿
- [ ] 摄像头启动时间 < 3秒

---

### 7.3 兼容性验收

- [ ] Chrome浏览器正常使用
- [ ] Safari浏览器正常使用
- [ ] 移动设备（iOS/Android）正常使用
- [ ] HTTPS环境下摄像头功能正常

---

### 7.4 用户体验验收

- [ ] 错误提示清晰易懂
- [ ] 加载状态有明确的视觉反馈
- [ ] 操作流程顺畅，无多余步骤
- [ ] 界面设计与现有风格一致

---

## 8. 依赖项

### 8.1 前端依赖

```json
{
  "tesseract.js": "^5.1.0"
}
```

### 8.2 后端依赖

无新增依赖（使用现有的AI服务）

### 8.3 浏览器API依赖

- FileReader API（文件读取）
- MediaDevices.getUserMedia API（摄像头访问）
- Canvas API（图片处理）
- Web Workers API（OCR异步处理）

---

## 9. 风险评估

### 9.1 技术风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|---------|------|---------|
| OCR识别准确率低 | 中 | 用户需要多次重试 | 优化图片预处理，提供图像增强建议 |
| 摄像头权限被拒绝 | 低 | 无法使用拍照功能 | 提供清晰的权限说明和引导 |
| 浏览器兼容性问题 | 中 | 部分用户无法使用 | 提供功能检测和降级方案 |
| 大图片处理性能 | 低 | 识别时间长 | 限制图片大小，压缩处理 |

---

### 9.2 业务风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|---------|------|---------|
| 识别错误导致分析失败 | 中 | 用户体验差 | 提供文本编辑功能，允许手动修正 |
| 隐私安全顾虑 | 低 | 用户不愿使用 | 明确说明数据处理方式（本地OCR） |
| API调用成本增加 | 中 | 服务器成本上升 | 添加限流机制，复用现有限流 |

---

## 10. 未来扩展

### 10.1 可能的功能扩展

1. **文本编辑功能**
   - 识别后允许用户手动编辑文本
   - 修正OCR识别错误

2. **多语言支持**
   - 支持中文OCR识别
   - 支持其他语言识别

3. **批量处理**
   - 支持一次上传多张图片
   - 批量识别和分析

4. **历史记录**
   - 保存用户上传的图片和识别的文本
   - 支持查看历史分析记录

5. **图片增强**
   - 自动调整图片亮度、对比度
   - 图片去噪处理

---

## 11. 术语表

| 术语 | 定义 |
|------|------|
| OCR | Optical Character Recognition，光学字符识别 |
| Tesseract.js | 基于JavaScript的OCR库 |
| Web Worker | 浏览器后台线程，用于执行耗时任务 |
| MediaDevices API | 浏览器API，用于访问媒体设备（摄像头、麦克风） |
| Canvas API | 浏览器API，用于图像处理和绘制 |

---

## 12. 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| 1.0 | 2024-XX-XX | Development Team | 初始版本 |

---

## 13. 附录

### 13.1 API详细规格

参见技术规格章节 5.2.1

### 13.2 代码示例

参见实施文档或代码仓库

### 13.3 测试用例

参见测试文档

---

**文档状态**: ✅ 已完成  
**最后更新**: 2024-XX-XX  
**审核状态**: 待审核

